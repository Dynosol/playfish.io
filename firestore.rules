rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Rate limits: only Cloud Functions (admin SDK) can access
    match /rateLimits/{docId} {
      allow read, write: if false;
    }

    // Users: public read (for usernames), writes now handled by Cloud Functions
    match /users/{uid} {
      allow read: if request.auth != null;
      // Writes are now handled by Cloud Functions
      allow create, update, delete: if false;
    }

    // Unified chats collection
    match /chats/{chatId} {
      // Allow reading the chat document itself (if it exists)
      allow read: if request.auth != null;
      allow write: if false;

      match /messages/{messageId} {
        // Global chat: any authenticated user can read
        allow read: if request.auth != null && chatId == 'global';

        // Lobby/game chat: any authenticated user can read (allows spectators)
        allow read: if request.auth != null &&
                    chatId != 'global' &&
                    exists(/databases/$(database)/documents/lobbies/$(chatId));

        // Writes are now handled by Cloud Functions
        allow create, update, delete: if false;
      }
    }

    // Lobbies: public read, writes now handled by Cloud Functions
    match /lobbies/{lobbyId} {
      allow read: if request.auth != null;
      // Writes are now handled by Cloud Functions
      allow create, update, delete: if false;
    }

    // Deleted lobbies: archive-only (Cloud Functions only)
    match /deletedLobbies/{lobbyId} {
      allow read, write: if false;
    }

    // Games: players-only read, writes now handled by Cloud Functions
    match /games/{gameId} {
      allow read: if request.auth != null &&
                  request.auth.uid in resource.data.players;
      // Writes are now handled by Cloud Functions
      allow create, update, delete: if false;
    }

    // Completed games: archive collection (Cloud Functions only)
    match /completedGames/{gameId} {
      allow read, write: if false;
    }

    // Unfinished games: archive collection (Cloud Functions only)
    match /unfinishedGames/{gameId} {
      allow read, write: if false;
    }
  }
}
